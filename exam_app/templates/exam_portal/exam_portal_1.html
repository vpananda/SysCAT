{% extends "base.html" %} 
{% load static %} 
<style>
  .button-container {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    top: 20px;
    margin-bottom: 20px;
}
</style>
{% block body %}
{% block content %}
<div class="row" id="r1">
  <div class="col-md-9">
    <div class="container" id="b1">
      <div class="tab">
        {% for key,value in questions.items %}
        <button class="tablinks" onclick="openTab(event, '{{key}}')" {% if forloop.first %}id="defaultOpen"{% endif %}>{{key}}</button>
        {% endfor %}
        <button id="demo"></button>
    </div>
    
    
       
    {% for key, value in questions.items %}
    <div id="{{ key }}" class="tabcontent">
        <h3>{{ key }}</h3>
        {% for index, (question, options) in value.items|enumerate %}
            <div class="card" id="ques_card{{ index }}">
                <div class="card-body">
                    <p>Question {{ index+1 }}: {{ question }}</p>
                    {% for i, option in enumerate(options) %}
                        <input type="radio" id="option{{ i+1 }}_{{ index }}" name="option{{ index }}" value="{{ option }}" onclick="submitAnswer('{{ option }}')">
                        <label for="option{{ i+1 }}_{{ index }}">{{ option }}</label><br>
                    {% endfor %}
                    <div style="height: 100px;"></div>
                    <div class="button-container">
                        <a class="btn btn-primary" href="#ques_card{{ index-1 }}" {% if index==0 %} style="display:none" {% endif %}>Previous</a>
                        <a class="btn btn-primary" href="#ques_card{{ index+1 }}" {% if index==len(value.items)-1 %} style="display:none" {% endif %}>Next</a>
                        <button class="btn btn-danger" onclick="clearSelection('option{{ index }}')" style="float:right;">Clear Selection</button>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endfor %}

    
    
      
    </div>
    </div>
  <div class="col-md-3">
    <div class="row" id="r2">
      <img src="{% url 'videostream' stream_path='video' %}" class="center" />
    </div>
    <div class="row" id="r3">
      <h6>Welcome {{ request.session.username }}</h6>
      <h3>Instructions</h3>
      <ul>
        <li>You must use a functioning webcam and microphone</li>
        <li>
          No cell phones or other secondary devices in the room or test area
        </li>
        <li>No one else can be in the room with you</li>
        <li>No talking</li>
        <li>
          The testing room must be well-lit and you must be clearly visible
        </li>
        <li>No dual screens/monitors</li>
        <li>Do not leave the camera</li>
        <li>No use of additional applications or internet</li>
      </ul>
    </div>
    <div id="countdown" data-total-duration="{{ total_duration }}"></div>
    <div class="row" id="r4">
      <button class="btn btn-primary" onclick="submitForm()">Submit</button>
    </div>
  </div>
</div>
{% endblock %} 
{% block scripts %}
{% comment %} <script type="text/javascript" src="{% static 'js/app.js' %}"></script> {% endcomment %}
<script type="text/javascript">

  function openTab(evt, tabName, questionIndex) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
    
    if (questionIndex === undefined) {
      questionIndex = 1;
    }
    
    var questionCards = document.querySelectorAll("#" + tabName + " .card-body");
    for (i = 0; i < questionCards.length; i++) {
      questionCards[i].style.display = "none";
    }
    questionCards[questionIndex - 1].style.display = "block";
    
    var prevBtn = document.getElementById("prevBtn");
    var nextBtn = document.getElementById("nextBtn");
    
    if (questionIndex == 1) {
      prevBtn.style.display = "none";
    } else {
      prevBtn.style.display = "inline";
    }
    
    if (questionIndex == questionCards.length) {
      nextBtn.style.display = "none";
    } else {
      nextBtn.style.display = "inline";
    }
  }
  
  document.getElementById("defaultOpen").click();
  
  var prevBtn = document.getElementById("prevBtn");
  var nextBtn = document.getElementById("nextBtn");
  prevBtn.style.display = "none";
  nextBtn.style.display = "inline";
  
  prevBtn.addEventListener("click", function() {
    var currentTab = document.getElementsByClassName("active")[0];
    var currentQuestionIndex = parseInt(currentTab.getAttribute("data-question-index"));
    var prevQuestionIndex = currentQuestionIndex - 1;
    var tabName = currentTab.getAttribute("data-tab-name");
    openTab(evt, tabName, prevQuestionIndex);
  });
  
  nextBtn.addEventListener("click", function() {
    var currentTab = document.getElementsByClassName("active")[0];
    var currentQuestionIndex = parseInt(currentTab.getAttribute("data-question-index"));
    var nextQuestionIndex = currentQuestionIndex + 1;
    var tabName = currentTab.getAttribute("data-tab-name");
    openTab(evt, tabName, nextQuestionIndex);
  });
</script>
<script>
  //countdown timer
var countdownEl = document.getElementById('countdown');
var totalDuration = countdownEl.dataset.totalDuration;
var countDownDate = new Date().getTime() + (totalDuration *60* 1000);

console.log(countDownDate)

// Update the count down every 1 second
var x = setInterval(function() {

  // Get today's date and time
  var now = new Date().getTime();

  // Find the distance between now and the count down date
  var distance = countDownDate - now;

  // Time calculations for days, hours, minutes and seconds
  var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  var seconds = Math.floor((distance % (1000 * 60)) / 1000);

  // Display the result in the element with id="demo"
  document.getElementById("demo").innerHTML = hours + ":"
  + minutes + ":" + seconds + "";

  // If the count down is finished, write some text
  if (distance < 0) {
    clearInterval(x);
    document.getElementById("demo").innerHTML = "EXPIRED";
  }
}, 1000);
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  {% csrf_token %}
  <script>
    window.onbeforeunload = function () {return false;}
    function submitAnswer(answerValue) {
      var formData = {};
      var radios = document.querySelectorAll("input[type=radio]");
      for (var i = 0; i < radios.length; i++) {
        var name = radios[i].name;
        if (radios[i].checked) {
          formData[name] = radios[i].value;
        } 
        else if (!formData.hasOwnProperty(name)) {
          formData[name] = null;
        }
      }
      $.ajax({
        type: "POST",
        url: '{% url "submit_answers" %}',
        data: JSON.stringify(formData),
        beforeSend: function(xhr, settings) {
          xhr.setRequestHeader("X-CSRFToken", $('input[name="csrfmiddlewaretoken"]').val());
        },
        contentType: "application/json",
        dataType: "json",
        success: function(response) {
        },
        error: function(xhr, status, error) {
          
        },
      });
    }
    
  </script>
  
  
  <script>
    function clearSelection(name) {
    var radios = document.getElementsByName(name);
    for (var i = 0; i < radios.length; i++) {
        radios[i].checked = false;
          }
          submitAnswer();
      }
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.documentElement.requestFullscreen();
      });
    </script>


{% endblock scripts %} 
{% endblock body %}
